<!DOCTYPE html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<head>

</head>
<body>

<h1>Visualização de filmes</h1>



<br>

<div ng-app="myApp" ng-controller="myCtrl">
  <form>
    ID: <input type="text" ng-model="id"><br><br>

    <!--Curso: <input type="text" ng-model="curso"><br><br>-->
    <button ng-click="acessa()">ACESSA</button> &nbsp;

  </form>


  
  
  
  <p style="display: none;">Resultado: {{mensagem}}</p>
 
  <p style="display: none;">Outro resultado : {{listaFilmesUsuario}}</p>
  
  <p style="display: none;">Teste nota : {{mensagem3}}</p>
  
  <p style="display: none;">User : {{user}}</p>
  <br><br>
  <table cellspacing="8" >

    <tr >


      <td>  <img src="{{ filme.poster }}" alt="{{ filme.titulo }}" style="width:300px;height:450px;" ></td>
      
      
      <td>
      
      <table  cellpadding="20">
      <tr> <td><h1>{{filme.titulo}}</h1></td> </tr>
      <tr> <td>{{hdiretor}} {{filme.diretor}}  </td> </tr>
      <tr> <td>{{hgeneros}} {{filme.generos}}  </td> </tr>
      <tr> <td>{{hdata}} {{filme.ano}}  </td> </tr>
      <tr> <td>{{hsinopse}} {{filme.sinopse}} </td> </tr>

       
        <tr><td>

        </td></tr>
      
      
      </table>
        


      </td>
    </tr>
  </table>
  
    <form id="darNota" style="display: none;">
    Nota: (entre 1 e 5):
    <input type="number" ng-model="notaDada" min="1" max="5">
    <button  ng-click="darNotaFilme()">Dar nota</button> &nbsp;
    </form>  

    <p id="mostrarNota" style="display: none;"> Nota: {{nota}} </p>
    


</div>






<script>
var app = angular.module('myApp', []);
app.controller('myCtrl', function($scope, $http) {
  // ACESSA
  $scope.acessa = function() {
     //document.getElementById('darNota').style.display='block'; //TODO to tentando fazer isso. descomentar o codigo da ruim...
     //document.getElementById('mostrarNota').style.display='block';
     var url = "/filmes/" ;
     if ($scope.id != undefined) url = "/filmes/" + $scope.id;
     var request = $http({
                 "method": "get",
                  "url": url});
     request.success(function(reply) {
        $scope.mensagem = reply;
        if(reply != null) {
            $scope.filme = reply.filme;

            $scope.hdata = "Data:";
            $scope.hdiretor = "Direção:";
            $scope.hgeneros = "Gêneros:";
            $scope.hsinopse = "Sinopse: ";
            
            //TODO LOGICA PARA PEGAR A NOTA
            var request2 = $http({ "method":"get", "url":"/usuarios/" + 977}); //TODO remove fixo
            request2.success(function(reply2) {
                $scope.user = reply2.usuario;
                $scope.listaFilmesUsuario = reply2.usuario.lista;
                var aux = 0;
                for (i =0; i< reply2.usuario.lista.length; i++) {
                    if(reply2.usuario.lista[i].filmeId == $scope.filme.id) {
                            $scope.nota = reply2.usuario.lista[i].nota;
                            aux = 1;
                            
                    }
                    //$scope.listaFilmesUsuario = reply2.usuario;
                }
                
    
                if(aux == 1) {
                    document.getElementById('mostrarNota').style.display='block'; //mostra a nota...
                }
                else {
                    document.getElementById('darNota').style.display='block'; //da opcao de ver nota...
                }
                
            });
            request2.error(function(reply2) {
                $scope.listaFilmesUsuario = reply2;
            });


        } else {
            $scope.clear();
            $scope.mensagem = reply.resultado;
        }
     });
      request.error(function(reply) {
         alert("Falha na requisicao");
      }
    );
  };


  $scope.darNotaFilme = function() {
    var novaLista = new Array();
    for (i = 0; i < $scope.listaFilmesUsuario.length; i++) {
        novaLista.push($scope.listaFilmesUsuario[i]);        
    }
    var novaNota = {
        "filmeId": $scope.filme.id,
        "titulo": $scope.filme.titulo,
        "nota": $scope.notaDada,
        "poster":$scope.filme.poster
    }
    novaLista.push(novaNota);
    
    $scope.user.lista = novaLista;
    $scope.mensagem3 = $scope.user;
    
    document.getElementById('mostrarNota').style.display='block'; //mostra a nota...
    document.getElementById('darNota').style.display='none'; //da opcao de ver nota...
    
    var request = $http({"method": "put",
                        "url": "/usuarios/" + 977, //TODO remove fixo
                        "data": {"usuario" : $scope.user}});
    
    request.success(function(reply) {
        if (reply.resultado == "SUCESSO"){
            $scope.mensagem = "Nota adicionada";
            $scope.nota = $scope.notaDada;
        } else {
            $scope.mensagem = reply.resultado;
        }
    });
    
    request.error(function(reply) {
        alert("Falha na requisicao");
    });
    
  };
  
  
  // CLEAR
  $scope.clear = function() {
    $scope.alunos = [];
    $scope.mensagem = "";
    $scope.hra = $scope.hnome = $scope.hcurso = "";
    }
  }
);
</script> 

</body>
</html>
