<!DOCTYPE html>
<html>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.4.8/angular.min.js"></script>
<body>

<h1>Lista de filmes</h1>

<br>

<div ng-app="myApp" ng-controller="myCtrl">
    
    <form>
        Busca por título: <input type="text" ng-model="barraPesquisa"> &nbsp;
        <button ng-click="busca()">BUSCA</button> &nbsp;
        <button ng-click="lista()">MINHA LISTA</button> &nbsp;
    </form>

    <br><br>
    {{mensagem}}  <!-- Displaying results -->
    <br><br>
    {{t}}
    <br><br>
    <a href="#" id="Ação" data-ng-click="filtrar($event)"> Ação</a> &nbsp;
    <a href="#" id="Comédia" data-ng-click="filtrar($event)"> Comédia</a> &nbsp;
    <a href="#" id="Drama" data-ng-click="filtrar($event)"> Drama</a> &nbsp;
    <a href="#" id="Ficção" data-ng-click="filtrar($event)"> Ficção</a> &nbsp;
    <a href="#" id="Romance" data-ng-click="filtrar($event)"> Romance</a> &nbsp;
    <a href="#" id="Romance" data-ng-click="filtrar($event)"> Terror</a> &nbsp;
    <a href="#" id="Lançamento" data-ng-click="lancamento()"> Lançamentos</a> &nbsp;
  
    <br><br>
    <table cellspacing="8"> <!-- table with all the movies -->  
        
        <tr> <!-- table header -->
            <th></th>
            <th>{{cabecalhoTabela}}</th>
        </tr>
        
        <tr ng-repeat="filme in filmes"> <!-- each row has information about a movie. The number of rows is defined by the number of movies -->
        
            <!-- first column: movie poster -->
            <td>
                <img src="{{ filme.trailer }}" alt="{{ filme.titulo }}" style="width:135px;height:185px;" >
            </td>
            
            <!-- second columm: movie details -->
            <td>
                <table cellspacing="8">
                    <tr><td>Id: {{ filme.id }}</td></tr>
                    <tr><td>Titulo: {{ filme.titulo }}</td><tr>
                    <tr><td>Generos: {{ filme.generos }}</td></tr>
                    <tr><td><a href="http://localhost:3000/filmes/{{ filme.id }}"> Detalhes </a> </td></tr>
                </table>
            </td>
        </tr>
            
    </table>

    <br><br>
    <table cellspacing="8"> <!-- movie list -->  
        
        <tr> <!-- table header -->
            <th></th>
            <th>{{cabecalhoTabela}}</th>
        </tr>
        
        <tr ng-repeat="item in lista"> <!-- each row has movie title and score -->
        
            <td>Titulo: {{ item.titulo }}</td>
            <td>Nota: {{ item.nota }}</td>
            <td><a href="#" id="{{ item.filmeId }}" data-ng-click="removerNota($event)"> Remover nota</a> </td>
        </tr>
            
    </table>
    
</div>


<script>
var app = angular.module('myApp', []);

//Service to get data when page loads
app.service('dataService', function($http){
    
    this.getData = function(callbackFunction){
       
        $http({
            "method": "get", "url": "/filmes"
        }).success(function(reply) {
            callbackFunction(reply);
        }).error(function() {
            reply.resultado = "Houve um problema na requisição. Tente novamente mais tarde."
            callbackFunction(reply);
        });
    }
});

app.controller('myCtrl', function($scope, $http, dataService) {
    
    dataService.getData(function(reply){
        if(reply.filmes != null) {
            $scope.cabecalhoTabela = "Informações";
            $scope.mensagem = "";
            $scope.filmes = reply.filmes;
        } else {
            $scope.cabecalhoTabela = "";
            $scope.mensagem = reply.resultado;
            $scope.filmes = [];
        }
    });
    
    // Listing movies added to personal list 
    $scope.lista = function() {
        
        $scope.cabecalhoTabela = "";
        $scope.tituloLista = "";
        
        $scope.clear();
                
        //if ($scope.id != undefined) url = "/lista/" + $scope.id;
        var request = $http({"method": "get", "url": "/usuarios/977"}); //TODO remove id fixo
        request.success(function(reply) {
            if(reply.usuario != null) {
                $scope.tituloLista = "Meus filmes";
                $scope.mensagem = reply.usuario;
                $scope.lista = reply.usuario.lista;
                $scope.user = reply.usuario;
                $scope.mensagem = $scope.user;
            } else {
                $scope.mensagem = reply.resultado;
            }
        });
    
        request.error(function(reply) {
            alert("Falha na requisicao");
        });
    };
    
    // Searching movies by name
    $scope.busca = function() {
    
        $scope.tituloLista = "";
    
        $scope.clear();
    
        if ($scope.barraPesquisa == undefined || $scope.barraPesquisa.length == 0) {
            $scope.mensagem = "Preencha o campo de busca";
            return;
        }
    
        var data = {"busca": $scope.barraPesquisa };
        var request = $http({"method": "post", "url": "/filmes", "data": data});
        request.success(function(reply) {
            $scope.mensagem = reply.resultado;
            $scope.filmes = reply.filmes;
        });
    
        request.error(function(reply) {
            alert("Falha na requisicao");
        });
    };

    // Filtering movies by genre
    $scope.filtrar = function(data) {
    
        $scope.clear();
        $scope.tituloLista = "Meus filmes";
        
        $scope.mensagem = data.target.id;
    
        var data = {"filtro": data.target.id };
        var request = $http({"method": "post", "url": "/filmes", "data": data});
        request.success(function(reply) {
            $scope.mensagem = reply.resultado;
            $scope.filmes = reply.filmes;
        });
    
        request.error(function(reply) {
            alert("Falha na requisicao");
        });
    };
    
    // Getting recent movies
    $scope.lancamento = function(data) {
    
        $scope.clear();
        
        $scope.mensagem = data.target.id;
    
        var data = {"lançamentos": "2017" };
        var request = $http({"method": "post", "url": "/filmes", "data": data});
        request.success(function(reply) {
            $scope.mensagem = reply.resultado;
            $scope.filmes = reply.filmes;
        });
    
        request.error(function(reply) {
            alert("Falha na requisicao");
        });
    };

    // Remove score
    $scope.removerNota = function(data) {
    
        var novaLista = new Array();
        for (i = 0; i < $scope.lista.length; i++) {
            if ($scope.lista[i].filmeId != data.target.id){
                novaLista.push($scope.lista[i]);
            }
        }
    
        $scope.user.lista = novaLista;
        $scope.mensagem = "";//$scope.user;
        $scope.lista = [];

        var request = $http({"method": "put",
                             "url": "/usuarios/" + 977, //TODO remove fixo
                             "data": {"usuario" : $scope.user}});
        
        request.success(function(reply) {
            if (reply.resultado == "SUCESSO"){
                $scope.mensagem = "Nota removida";
                $scope.lista = reply.usuario.lista;
            } else {
                $scope.mensagem = reply.resultado;
                $scope.lista = reply.usuario.lista;
            }
        });
        
        request.error(function(reply) {
            alert("Falha na requisicao");
        });
    
    };

  
  
  // REMOVE
  /*
  $scope.remove = function() {
     $scope.clear();
     if ($scope.id == undefined || $scope.id.length == 0) {
         $scope.clear();
         $scope.mensagem = "preencha o id do aluno";
         return;
     }
     var request = $http({
                 "method": "delete",
                 "url": "/filmes/" + $scope.id});
     request.success(function(reply) {
         $scope.mensagem = reply.resultado;
       }
     );
     request.error(function(reply) {
        alert("Falha na requisicao");
       });
   };
*/
   
    // CLEAR
    $scope.clear = function() {
        $scope.filmes = [];
        $scope.mensagem = "";
        $scope.cabecalhoTabela = "";
        $scope.tituloLista = "Meus filmes";
    };
});
</script> 

</body>
</html>
